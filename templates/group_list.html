{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center text-primary mb-4">Available Groups</h2>
  <input type="text" id="groupSearch" class="form-control mb-4" placeholder="Search groups by name or description...">
  <script>
    document.getElementById('groupSearch').addEventListener('input', function () {
      const searchTerm = this.value.toLowerCase();
      const groupCards = document.querySelectorAll('.card');

      groupCards.forEach(card => {
        const groupName = card.querySelector('.card-title').textContent.toLowerCase();
        const groupDescription = card.querySelector('.card-header small').textContent.toLowerCase();

        if (groupName.includes(searchTerm) || groupDescription.includes(searchTerm)) {
          card.parentElement.style.display = 'block';
        } else {
          card.parentElement.style.display = 'none';
        }
      });
    });
  </script>

  <div class="row">
    {% for group in groups %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">{{ group.name }}</h5>
          <small class="d-block">{{ group.description }}</small>
          <small class="d-block">
            {% if group.is_public %}
            <span class="badge bg-success">Public</span>
            {% else %}
            <span class="badge bg-secondary">Private</span>
            {% endif %}
          </small>
        </div>
        <div class="card-body">
          <div class="mb-3">
            {% if group.created_by == current_user.id %}
            <span class="badge bg-info text-white">You are the Admin</span>
            {% else %}
            {% set membership = group.members | selectattr("user_id", "equalto", current_user.id) | first %}
            {% if membership %}
            {% if membership.is_approved %}
            <form action="{{ url_for('leave_group', group_id=group.id) }}" method="POST">
              <button type="submit" class="btn btn-outline-danger btn-sm">Leave Group</button>
            </form>
            {% else %}
            <span class="badge bg-warning">Request Sent - Awaiting Approval</span>
            {% endif %}
            {% else %}
            <form action="{{ url_for('join_group', group_id=group.id) }}" method="POST">
              <button type="submit" class="btn btn-outline-primary btn-sm">Join Group</button>
            </form>
            {% endif %}
            {% endif %}
          </div>
          <a href="{{ url_for('group_chat', group_id=group.id) }}" class="btn btn-secondary btn-block mb-2">Open
            Chat</a>

          {% if group.created_by == current_user.id %}
          <form action="{{ url_for('delete_group', group_id=group.id) }}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete this group and its messages?');">
            <button type="submit" class="btn btn-danger btn-sm btn-block">Delete Group</button>
          </form>
          <form action="{{ url_for('edit_group', group_id=group.id) }}" method="GET" class="mt-2">
            <button type="submit" class="btn btn-warning btn-sm btn-block">Edit Group</button>
          </form>
          {% endif %}

          <form action="{{ url_for('delete_chats', group_id=group.id) }}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete all chat messages on this device?');"
            class="mt-2">
            <button type="submit" class="btn btn-warning btn-sm btn-block">Delete Chat</button>
          </form>
          <button class="btn btn-outline-secondary btn-sm btn-block mt-2"
            onclick="copyGroupLink('{{ url_for('group_chat', group_id=group.id, _external=True) }}')">Share</button>
          <script>
            function copyGroupLink(link) {
              navigator.clipboard.writeText(link).then(() => {
                alert('Group link copied to clipboard!');
              }).catch(err => {
                console.error('Failed to copy link: ', err);
              });
            }
          </script>

        </div>
        <div class="card-footer bg-light">
          <button class="btn btn-info btn-sm btn-block" data-bs-toggle="collapse"
            data-bs-target="#membersCollapse{{ group.id }}" aria-expanded="false"
            aria-controls="membersCollapse{{ group.id }}">
            Toggle Members
          </button>
          <p class="mt-2 text-center">
            Total Members: {{ group.members | length + 1 }}
          </p>
          <div class="collapse mt-3" id="membersCollapse{{ group.id }}">
            <ul class="list-group list-group-flush">
              {% set admin_user = group.created_by %}
              {% set admin = users | selectattr('id', 'equalto', admin_user) | first %}
              {% if admin %}
              <li class="list-group-item bg-light border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>{{ admin.username }}</strong>
                  <span class="badge bg-info">Admin</span>
                </div>
              </li>
              {% else %}
              <li class="list-group-item">Admin not found.</li>
              {% endif %}

              {% for member in group.members %}
              <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center">
                  <span class="me-2">{{ member.user.username }}</span>

                  {% if member.is_admin %}
                  <span class="badge bg-info me-2">Admin</span>
                  {% elif member.is_approved %}
                  <span class="badge bg-success me-2">Approved</span>
                  {% else %}
                  <span class="badge bg-warning me-2">Pending</span>
                  {% if group.created_by == current_user.id %}
                  <form action="{{ url_for('approve_member', membership_id=member.id) }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="btn btn-success btn-sm me-2">Approve</button>
                  </form>
                  <form action="{{ url_for('reject_member', membership_id=member.id) }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm me-2">Reject</button>
                  </form>
                  {% endif %}
                  {% endif %}
                </div>

                <div class="d-flex">

                  {% if group.created_by == current_user.id and member.user.id != current_user.id %}
                  <form action="{{ url_for('remove_member', group_id=group.id, user_id=member.user.id) }}" method="POST"
                    class="me-2">
                    <button type="submit" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                      title="Remove from Group">
                      Kick
                    </button>
                  </form>
                  {% endif %}


                  {% if group.created_by == current_user.id %}
                  {% if not member.is_admin %}
                  <form action="{{ url_for('promote_to_admin', group_id=group.id, user_id=member.user.id) }}"
                    method="POST" class="me-2">
                    <button type="submit" class="btn btn-success btn-sm" data-bs-toggle="tooltip"
                      data-bs-placement="top" title="Promote to Admin">
                      Promote
                    </button>
                  </form>
                  {% else %}
                  <form action="{{ url_for('demote_from_admin', group_id=group.id, user_id=member.user.id) }}"
                    method="POST" class="me-2">
                    <button type="submit" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                      title="Remove Admin Privileges">
                      Demote
                    </button>
                  </form>
                  {% endif %}
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>

            <style>
              .list-group-item {
                border-radius: 10px;
                background-color: #f8f9fa;
                transition: all 0.3s ease;
              }

              .list-group-item:hover {
                background-color: #e9ecef;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
              }

              .list-group-item .badge {
                font-size: 0.85rem;
                padding: 0.4em 0.6em;
              }

              .btn-sm {
                font-size: 0.85rem;
                padding: 0.25rem 0.75rem;
              }

              .btn-danger {
                background-color: #dc3545;
                border: 1px solid #dc3545;
              }

              .btn-danger:hover {
                background-color: #c82333;
              }

              .btn-success {
                background-color: #28a745;
                border: 1px solid #28a745;
              }

              .btn-success:hover {
                background-color: #218838;
              }

              .btn-info {
                background-color: #17a2b8;
                border: 1px solid #17a2b8;
              }

              .btn-info:hover {
                background-color: #138496;
              }

              .tooltip-inner {
                background-color: #343a40;
                color: #fff;
                padding: 0.5rem;
                border-radius: 5px;
              }

              #membersCollapse {
                  {
                  group.id
                }
              }

                {
                max-height: 300px;
                overflow-y: auto;
                overflow-x: auto;
              }

              @media (max-width: 576px) {
                .btn-block {
                  width: 100%;
                }
              }

              @media (max-width: 768px) {
                .card-body {
                  padding: 1rem;
                }

                .card-header {
                  padding: 0.75rem;
                }
              }
            </style>

            <script>
              var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
              tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
              });
            </script>

          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}