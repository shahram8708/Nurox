{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">

    <div class="text-center mb-5">
        <h2 class="display-4 font-weight-bold text-info">{{ problem.title }}</h2>
        <p class="lead text-muted">Posted under the sector: <strong>{{ problem.sector }}</strong></p>
        <p class="text-muted">Submitted on: <em>{{ problem.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</em></p>
        <p class="text-muted">
            <strong>Posted by: </strong>
            <a href="{{ url_for('user_profile', user_id=problem.user.id) }}" class="text-info">{{ problem.user.username
                }}</a>
        </p>
    </div>


    <div class="card shadow-lg rounded-lg border-0">
        <div class="card-body">
            <h5 class="font-weight-bold text-dark mb-3">Problem Description</h5>
            <p>{{ problem.description | replace("\n", "<br>") | safe }}</p>


            <div class="mb-3">
                {% if current_user.id == problem.user_id %}
                <a href="{{ url_for('edit_problem', problem_id=problem.id) }}"
                    class="btn btn-warning btn-sm mr-2">Edit</a>
                <form method="POST" action="{{ url_for('delete_problem', problem_id=problem.id) }}"
                    style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm"
                        onclick="return confirm('Are you sure you want to delete this problem?');">Delete</button>
                </form>
                {% endif %}
                {% if current_user.user_type in ['entrepreneur_innovator', 'both'] %}
                <p class="mt-3"><strong>Problem Authenticity:</strong>
                    {% if problem.likes + problem.unlikes > 0 %}
                    {{ authenticity }}% real
                    {% else %}
                    No feedback yet
                    {% endif %}
                </p>
                <div class="mt-3">
                    <p class="text-muted">
                        This problem's authenticity is calculated based on the feedback from other users and the
                        analysis done through machine learning algorithms.
                        According to our analysis, this problem is {{ authenticity }}% authentic.
                        However, even with this high authenticity percentage, it is essential that you engage in
                        discussions and research further to explore the solution possibilities.
                        The more insights and research we gather, the better we can address this problem together.
                    </p>
                </div>
                <div class="card mt-4 shadow-sm border-0 rounded-4"
                    style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                    <div class="card-header text-white bg-primary rounded-top-4 d-flex align-items-center justify-content-between"
                        style="padding: 1rem 1.5rem;">
                        <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Analysis</h5>
                        <span class="badge bg-light text-dark">Insight</span>
                    </div>
                    <div class="card-body p-4">
                        <blockquote class="blockquote text-muted">
                            <p id="ai-analysis-short" class="mb-0">{{ problem.ai_analysis[:100] }}...</p>
                            <p id="ai-analysis-full" class="mb-0" style="display: none;">{{ problem.ai_analysis }}</p>
                        </blockquote>
                        <button id="view-more-btn" class="btn mt-3" style="
                            font-size: 14px;
                            color: #ffffff;
                            background: linear-gradient(135deg, #007bff, #0056b3);
                            border: none;
                            border-radius: 25px;
                            padding: 8px 20px;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
                        " onclick="toggleViewMore()">View More</button>
                        <footer class="blockquote-footer mt-3">
                            Generated by <cite title="Source">AI</cite>
                        </footer>
                    </div>
                </div>

                <script>
                    const button = document.getElementById('view-more-btn');
                    button.addEventListener('mouseover', function () {
                        button.style.background = 'linear-gradient(135deg, #0056b3, #007bff)';
                        button.style.boxShadow = '0 6px 10px rgba(0, 123, 255, 0.3)';
                    });

                    button.addEventListener('mouseout', function () {
                        button.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                        button.style.boxShadow = '0 4px 6px rgba(0, 123, 255, 0.2)';
                    });

                    function toggleViewMore() {
                        const shortAnalysis = document.getElementById('ai-analysis-short');
                        const fullAnalysis = document.getElementById('ai-analysis-full');
                        const viewMoreBtn = document.getElementById('view-more-btn');

                        if (fullAnalysis.style.display === "none") {
                            fullAnalysis.style.display = "block";
                            shortAnalysis.style.display = "none";
                            viewMoreBtn.innerHTML = "View Less";
                        } else {
                            fullAnalysis.style.display = "none";
                            shortAnalysis.style.display = "block";
                            viewMoreBtn.innerHTML = "View More";
                        }
                    }
                </script>
                {% endif %}

                <div class="mt-3">
                    <form method="POST" class="d-inline-block"
                        action="{{ url_for('problem_details', problem_id=problem.id) }}">
                        {% if current_user not in problem.liked_users %}
                        <button type="submit" name="like" class="btn btn-outline-success btn-sm">Like</button>
                        {% else %}
                        <button type="submit" name="like" class="btn btn-success btn-sm" disabled>Liked</button>
                        {% endif %}

                        {% if current_user not in problem.unliked_users %}
                        <button type="submit" name="unlike" class="btn btn-outline-danger btn-sm ml-2">Unlike</button>
                        {% else %}
                        <button type="submit" name="unlike" class="btn btn-danger btn-sm ml-2" disabled>Unliked</button>
                        {% endif %}
                    </form>
                </div>
                <div class="mt-2">
                    <strong>Likes:</strong> {{ problem.likes }} | <strong>Unlikes:</strong> {{ problem.unlikes }}
                    <p class="text-muted mt-2">
                        <strong>Like:</strong> If you believe that this problem is real and important in life, click
                        "Like". This helps others understand the significance of this problem.
                    </p>
                    <p class="text-muted mt-2">
                        <strong>Unlike:</strong> If you feel that this problem isn't relevant or important, or if a
                        solution isn't necessary, and you think that a solution should be found, click "Unlike". Your
                        feedback helps refine the focus of the community discussions.
                    </p>
                </div>


                <div class="mt-4">
                    <button class="btn btn-info btn-sm"
                        onclick="copyToClipboard('{{ url_for('problem_details', problem_id=problem.id, _external=True) }}')">Share</button>
                    <span id="share-message" class="text-success ml-2" style="display: none;">Link copied to
                        clipboard!</span>
                </div>
                <script>
                    function copyToClipboard(url) {
                        navigator.clipboard.writeText(url).then(function () {
                            const message = document.getElementById('share-message');
                            message.style.display = 'inline';
                            setTimeout(() => {
                                message.style.display = 'none';
                            }, 3000);
                        }).catch(function (error) {
                            alert('Failed to copy the link: ' + error);
                        });
                    }
                </script>
            </div>
        </div>
    </div>


    <div class="mt-5">
        <h3 class="font-weight-bold text-dark mb-4">Discussions</h3>

        {% for section in [
        'Platform Discussion',
        'Problem Validation',
        'Problem Solving',
        'Entrepreneurial Opportunities',
        'Resource Sharing',
        'Community Experiences',
        'Solution Implementation Feedback',
        'Other'
        ] %}
        <div class="mb-4">
            <h4 class="font-weight-bold text-info">{{ loop.index }}. {{ section }}</h4>
            {% set has_discussions = false %}
            <div class="discussion-section"
                style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9;">
                <ul class="list-unstyled">
                    {% for discussion in discussions if discussion.section == section %}
                    {% set has_discussions = true %}
                    <li class="mb-3">
                        <strong>
                            <a href="{{ url_for('user_profile', user_id=discussion.user.id) }}" class="text-info">{{
                                discussion.user.username }}</a>
                        </strong>: {{ discussion.content }}
                        <em class="text-muted">({{ discussion.created_at.strftime('%Y-%m-%d %H:%M:%S') }})</em>
                        <ul class="list-unstyled mt-2">
                            {% for reply in discussion.replies %}
                            <li class="mt-2">
                                <strong>
                                    <a href="{{ url_for('user_profile', user_id=reply.user.id) }}" class="text-info">{{
                                        reply.user.username }}</a>
                                </strong>: {{ reply.content }}
                                <em class="text-muted">({{ reply.created_at.strftime('%Y-%m-%d %H:%M:%S') }})</em>
                            </li>
                            {% endfor %}
                        </ul>

                        <form method="POST" action="{{ url_for('add_reply', discussion_id=discussion.id) }}"
                            class="mt-2">
                            <textarea class="form-control" name="content" placeholder="Reply to this discussion..."
                                required></textarea>
                            <button type="submit" class="btn btn-outline-secondary btn-sm mt-2">Reply</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% if not has_discussions %}
                <p class="text-muted">Start a discussion!</p>
                {% endif %}
            </div>

            <form method="POST" action="{{ url_for('add_discussion', problem_id=problem.id) }}" class="mt-3">
                <input type="hidden" name="section" value="{{ section }}">
                <textarea class="form-control" name="content" placeholder="Add to this discussion..."
                    required></textarea>
                <button type="submit" class="btn btn-primary btn-sm mt-2">Submit</button>
            </form>
        </div>

        {% endfor %}
    </div>
</div>


<style>
    .card {
        background-color: #ffffff;
        border-radius: 10px;
    }

    .discussion-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }

    .discussion-section li {
        border-bottom: 1px solid #ddd;
    }

    .discussion-section li:last-child {
        border-bottom: none;
    }

    .discussion-section ul {
        padding-left: 20px;
    }

    .btn {
        border-radius: 25px;
    }

    .btn-outline-success {
        border-color: #28a745;
        color: #28a745;
    }

    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-info {
        border-color: #17a2b8;
    }

    .form-control {
        border-radius: 10px;
    }

    .lead {
        font-size: 1.2rem;
        font-weight: 500;
    }

    .font-weight-bold {
        font-weight: 600;
    }

    .text-muted {
        color: #6c757d;
    }

    .text-info {
        color: #17a2b8;
    }

    .text-dark {
        color: #343a40;
    }

    .text-success {
        color: #28a745;
    }
</style>

{% endblock %}