{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7 col-12">
            <div class="card border-0 shadow-lg rounded-4">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4">Change Password</h2>
                    <form method="POST" action="{{ url_for('change_password') }}" id="changePasswordForm">
                        <div class="mb-4">
                            <label for="current_password" class="form-label fs-5">Current Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="current_password"
                                    id="current_password" required placeholder="Enter current password">
                                <button type="button" class="btn btn-outline-secondary" id="toggleCurrentPassword">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="new_password" class="form-label fs-5">New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="new_password" id="new_password"
                                    required placeholder="Enter new password">
                                <button type="button" class="btn btn-outline-secondary" id="toggleNewPassword">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="confirm_password" class="form-label fs-5">Confirm New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="confirm_password"
                                    id="confirm_password" required placeholder="Re-enter new password">
                                <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="showPassword">
                                <label class="form-check-label" for="showPassword">Show Passwords</label>
                            </div>
                            <a href="{{ url_for('forgot_password') }}" class="text-muted" id="forgotPasswordLink">Forgot
                                Password?</a>
                        </div>

                        <div class="d-flex justify-content-center mb-4">
                            <button type="submit" class="btn btn-primary w-100" id="changePasswordButton" disabled>
                                <span id="buttonText">Change Password</span>
                                <div id="loadingIndicator" class="spinner-border text-white ms-2" role="status"
                                    style="display: none;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    const togglePasswordVisibility = (toggleButtonId, inputId) => {
        document.getElementById(toggleButtonId).addEventListener('click', function () {
            const passwordField = document.getElementById(inputId);
            const icon = this.querySelector('i');
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            } else {
                passwordField.type = 'password';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            }
        });
    };


    togglePasswordVisibility('toggleCurrentPassword', 'current_password');
    togglePasswordVisibility('toggleNewPassword', 'new_password');
    togglePasswordVisibility('toggleConfirmPassword', 'confirm_password');


    document.getElementById('showPassword').addEventListener('change', function () {
        let passwordFields = [
            document.getElementById('current_password'),
            document.getElementById('new_password'),
            document.getElementById('confirm_password')
        ];

        passwordFields.forEach(field => {
            field.type = this.checked ? 'text' : 'password';
        });
    });


    function checkPasswords() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const submitButton = document.getElementById('changePasswordButton');

        if (newPassword === confirmPassword && newPassword.length > 0) {
            submitButton.disabled = false;
            document.getElementById('buttonText').textContent = 'Change Password';
        } else {
            submitButton.disabled = true;
            document.getElementById('buttonText').textContent = 'Passwords do not match';
        }
    }


    document.getElementById('new_password').addEventListener('input', checkPasswords);
    document.getElementById('confirm_password').addEventListener('input', checkPasswords);


    document.getElementById('changePasswordForm').addEventListener('submit', function () {
        document.getElementById('loadingIndicator').style.display = 'inline-block';
        document.getElementById('changePasswordButton').disabled = true;
    });
</script>
{% endblock %}